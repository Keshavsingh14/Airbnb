import * as fs from 'fs'
import * as path from 'path'
import {promisify} from 'util'
import * as parser from 'js-yaml'

export async function listing(root = '.', ext = '.md') {
  const readDir = promisify(fs.readdir)
  const readFile = promisify(fs.readFile)

  try {
    const files = await readDir(root)

    const bufs = files
      .filter(filename => filename.endsWith(ext))
      .map(file => readFile(file))

    return Promise.all(bufs)
  } catch(ex) {
    console.error(ex)
    return Promise.resolve([])
  }
}

interface BufYaml {
  buf: Buffer
  json: object
}
export function getMeta(buf): Meta {
  const [first , yaml, ...rest] = buf.toString().split('---')
  return parser.safeLoad(yaml)
}
export async function setMeta(buf, json: Meta) {
  const [first , _, ...rest] = buf.toString().split('---')
  return ['---', first, parser.safeDump(json), ...rest].join('---')
}

interface Meta {
  title: string
}
