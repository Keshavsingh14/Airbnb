import * as Server from 'socket.io'
import * as http from 'http'
import {getMeta, listing} from './index'

declare const process: any

const port = 3002
let server = http.createServer()
const io = Server(server)

io.on('connection', async (socket) => {
  console.log('connected')
  const list = await listing()
  const data = list.map(getMeta)
  socket.emit('message', 'server')
  socket.emit('message', JSON.stringify(data))
  socket.on('message', (message) => {
    console.log(`from client: ${message}`)
  })
  socket.on('disconnect', () => {
    console.log('disconnected')
  })
})

server.listen(port, (err) => {
  if (err) {
    throw err
  }
  console.log(`> [Ready on http://localhost:${port}`)
})
